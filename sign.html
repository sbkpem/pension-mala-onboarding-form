export const EXTERNAL_FORM_HTML = `
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס הצטרפות - פנסיון מלא</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #eff6ff, #e0e7ff);
            min-height: 100vh;
            padding: 2rem 1rem;
            direction: rtl;
        }
        .container { max-width: 720px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header img { height: 80px; margin-bottom: 1rem; }
        .header h1 { font-size: 1.75rem; color: #111827; margin-bottom: 0.5rem; }
        .header p { color: #6b7280; }
        .steps { display: flex; justify-content: space-between; margin-bottom: 2rem; padding: 0 1rem; }
        .step { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .step-circle {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: #e5e7eb; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem; transition: all 0.3s;
        }
        .step-circle.active { background: #2563eb; color: white; box-shadow: 0 2px 8px rgba(37,99,235,0.3); }
        .step-label { font-size: 0.75rem; text-align: center; color: #6b7280; }
        .step-label.active { color: #2563eb; font-weight: 500; }
        .card {
            background: white; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(to left, #eff6ff, #dbeafe);
            padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;
        }
        .card-header h2 { font-size: 1.25rem; color: #1e3a8a; }
        .card-header p { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
        .card-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.375rem; }
        .form-group input, .form-group select {
            width: 100%; padding: 0.625rem 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 0.875rem; transition: border-color 0.2s; direction: rtl; text-align: right;
            background-color: white; color: #111827;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        /* Fix 1: placeholder style for select */
        .form-group select:invalid,
        .form-group select option[value=""][disabled] {
            color: #9ca3af;
        }
        .form-group select option:not([disabled]) {
            color: #111827;
        }
        /* Fix 2: select arrow positioning */
        .form-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            background-size: 16px;
            padding-left: 2.5rem;
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        @media (max-width: 640px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        .section-box {
            background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1.25rem;
        }
        .section-box.blue { background: #eff6ff; border-color: #bfdbfe; }
        .section-box h3 { font-size: 0.9375rem; font-weight: 600; margin-bottom: 0.75rem; }
        .section-box.blue h3 { color: #1e3a8a; }
        .btn-row { display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
        .btn {
            padding: 0.625rem 1.5rem; border-radius: 8px; font-size: 0.875rem; font-weight: 500;
            cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-outline { background: white; color: #374151; border: 1px solid #d1d5db; }
        .btn-outline:hover:not(:disabled) { background: #f9fafb; }
        .error-box {
            display: flex; align-items: center; gap: 0.5rem; padding: 1rem;
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #b91c1c; margin-top: 1rem;
        }
        .success-screen {
            text-align: center; padding: 3rem 2rem; background: white; border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 480px; margin: 4rem auto;
        }
        .success-icon {
            width: 80px; height: 80px; background: #dcfce7; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;
        }
        .success-icon svg { width: 48px; height: 48px; color: #16a34a; }
        .hidden { display: none; }
        .footer { text-align: center; font-size: 0.8rem; color: #9ca3af; margin-top: 1.5rem; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* File upload area */
        .file-upload-area {
            border: 2px dashed #d1d5db; border-radius: 8px; padding: 1.5rem; text-align: center;
            cursor: pointer; transition: all 0.2s; background: #fafafa;
        }
        .file-upload-area:hover { border-color: #2563eb; background: #eff6ff; }
        .file-upload-area.uploaded { border-color: #16a34a; background: #f0fdf4; cursor: default; }
        .file-upload-area input[type="file"] { display: none; }
        .file-upload-icon { width: 32px; height: 32px; margin: 0 auto 0.5rem; color: #9ca3af; }
        .file-upload-area.uploaded .file-upload-icon { color: #16a34a; }
        .file-upload-text { font-size: 0.875rem; color: #6b7280; }
        .file-upload-hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }
        .file-replace-btn {
            margin-top: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: 6px;
            border: 1px solid #d1d5db; background: white; cursor: pointer; color: #374151;
        }
        .file-replace-btn:hover { background: #f3f4f6; }
    </style>
</head>
<body>

<div class="container">
    <!-- Success Screen -->
    <div id="successScreen" class="success-screen hidden">
        <div class="success-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <h2 style="font-size:1.5rem;color:#111827;margin-bottom:1rem;">הטופס נשלח בהצלחה!</h2>
        <p style="color:#6b7280;margin-bottom:0.5rem;">תודה על פנייתכם! קיבלנו את פרטי ההצטרפות. מסמכי ההצטרפות יועברו לחתימת מורשי החתימה שלכם בהקדם.</p>
        <p style="font-size:0.875rem;color:#9ca3af;">צוות פנסיון מלא</p>
    </div>

    <!-- Main Form -->
    <div id="mainForm">
        <div class="header">
            <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/684b22e06236d9fe79c43c9f/7669b86da_.png" alt="פנסיון מלא" />
            <h1>טופס הצטרפות לפנסיון מלא</h1>
            <p>מלאו את הפרטים להצטרפות לשירותי תפעול פנסיוני</p>
        </div>

        <div class="steps">
            <div class="step"><div class="step-circle active" id="stepCircle1">1</div><span class="step-label active" id="stepLabel1">פרטי החברה</span></div>
            <div class="step"><div class="step-circle" id="stepCircle2">2</div><span class="step-label" id="stepLabel2">אנשי קשר</span></div>
            <div class="step"><div class="step-circle" id="stepCircle3">3</div><span class="step-label" id="stepLabel3">פרטי תשלום</span></div>
            <div class="step"><div class="step-circle" id="stepCircle4">4</div><span class="step-label" id="stepLabel4">מורשי חתימה</span></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 id="stepTitle">פרטי החברה</h2>
                <p id="stepDesc">שלב 1 מתוך 4</p>
            </div>
            <div class="card-body">

                <!-- Step 1: פרטי החברה -->
                <div id="step1">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>שם החברה *</label>
                            <input type="text" id="company_name" placeholder="שם החברה המלא" />
                        </div>
                        <div class="form-group">
                            <label>ח.פ. / ע.מ. *</label>
                            <input type="text" id="business_id" placeholder="מספר חברה / עוסק מורשה" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>כתובת *</label>
                        <input type="text" id="address" placeholder="כתובת מלאה" />
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>טלפון *</label>
                            <input type="text" id="phone" placeholder="טלפון ראשי" />
                        </div>
                        <div class="form-group">
                            <label>מס' תיק ניכויים *</label>
                            <input type="text" id="deductions_file_number" placeholder="מספר תיק ניכויים" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>קוד מוסד במס"ב *</label>
                        <select id="has_masav_code" onchange="toggleMasavFields()" required>
                            <option value="" disabled selected hidden>נא לבחור</option>
                            <option value="yes">כן</option>
                            <option value="no">לא</option>
                        </select>
                    </div>
                    <div id="masavFields" class="hidden">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>קוד מוסד במס"ב *</label>
                                <input type="text" id="institution_code" placeholder="קוד מוסד" />
                            </div>
                            <div class="form-group">
                                <label>שם מוסד במס"ב *</label>
                                <input type="text" id="institution_name" placeholder="שם המוסד" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: אנשי קשר -->
                <div id="step2" class="hidden">
                    <div class="section-box blue">
                        <h3>איש קשר ראשי *</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>שם מלא *</label>
                                <input type="text" id="main_contact_name" placeholder="שם איש הקשר" />
                            </div>
                            <div class="form-group">
                                <label>תפקיד</label>
                                <input type="text" id="main_contact_role" placeholder="תפקיד בחברה" />
                            </div>
                            <div class="form-group">
                                <label>טלפון *</label>
                                <input type="text" id="main_contact_phone" placeholder="מספר טלפון" />
                            </div>
                            <div class="form-group">
                                <label>אימייל *</label>
                                <input type="email" id="main_contact_email" placeholder="כתובת אימייל" />
                            </div>
                        </div>
                    </div>
                    <div class="section-box">
                        <h3>איש קשר שכר (הנה"ח)</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>שם *</label>
                                <input type="text" id="payroll_contact_name" placeholder="שם איש קשר שכר" />
                            </div>
                            <div class="form-group">
                                <label>אימייל *</label>
                                <input type="email" id="payroll_contact_email" placeholder="אימייל שכר" />
                            </div>
                            <div class="form-group">
                                <label>טלפון</label>
                                <input type="text" id="payroll_contact_phone" placeholder="טלפון איש קשר שכר" />
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>אימייל לחשבוניות *</label>
                        <input type="email" id="invoice_email" placeholder="אימייל לקבלת חשבוניות" />
                    </div>
                </div>

                <!-- Step 3: פרטי תשלום -->
                <div id="step3" class="hidden">
                    <div class="form-group">
                        <label>אופן תשלום לקופות *</label>
                        <select id="payment_method_to_funds" required>
                            <option value="" disabled selected hidden>נא לבחור</option>
                            <option value="bank_transfer">העברה בנקאית</option>
                            <option value="masav">מס"ב</option>
                            <option value="interface_authorization">הרשאה לחיוב חשבון לפי ממשק</option>
                        </select>
                    </div>
                    <div class="section-box">
                        <h3>פרטי חשבון בנק *</h3>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>בנק *</label>
                                <select id="bank_name" required>
                                    <option value="" disabled selected hidden>נא לבחור</option>
                                    <option value="10">10 - בנק לאומי</option>
                                    <option value="11">11 - בנק דיסקונט</option>
                                    <option value="12">12 - בנק הפועלים</option>
                                    <option value="13">13 - בנק איגוד</option>
                                    <option value="14">14 - בנק אוצר החייל</option>
                                    <option value="17">17 - בנק מרכנתיל דיסקונט</option>
                                    <option value="20">20 - בנק מזרחי טפחות</option>
                                    <option value="31">31 - הבנק הבינלאומי</option>
                                    <option value="34">34 - בנק ערבי ישראלי</option>
                                    <option value="46">46 - בנק מסד</option>
                                    <option value="52">52 - בנק פועלי אגודת ישראל</option>
                                    <option value="54">54 - בנק ירושלים</option>
                                    <option value="99">99 - בנק ישראל</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>מספר סניף *</label>
                                <input type="text" id="bank_branch_number" placeholder="מספר סניף" />
                            </div>
                            <div class="form-group">
                                <label>מספר חשבון *</label>
                                <input type="text" id="bank_account_number" placeholder="מספר חשבון" />
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>חודש שכר לתחילת השירות</label>
                        <select id="salary_start_month">
                            <option value="" disabled selected hidden>נא לבחור</option>
                            <option value="current">נוכחי</option>
                            <option value="current_retro">נוכחי + רטרו</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>אופן תשלום לפנסיון מלא *</label>
                        <select id="payment_choice" required>
                            <option value="" disabled selected hidden>נא לבחור</option>
                            <option value="credit_card">כרטיס אשראי</option>
                            <option value="bank_debit">הוראת קבע בנקאית</option>
                        </select>
                    </div>
                </div>

                <!-- Step 4: מורשי חתימה -->
                <div id="step4" class="hidden">
                    <div class="form-group">
                        <label>מבנה חתימה *</label>
                        <select id="signature_structure" onchange="toggleSigner2()" required>
                            <option value="" disabled selected hidden>נא לבחור</option>
                            <option value="one_signer">חותם יחיד</option>
                            <option value="two_signers">שני חותמים</option>
                        </select>
                    </div>
                    <div class="section-box blue">
                        <h3>מורשה חתימה ראשון *</h3>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>שם מלא *</label>
                                <input type="text" id="signer_1_name" placeholder="שם מורשה חתימה" />
                            </div>
                            <div class="form-group">
                                <label>תעודת זהות *</label>
                                <input type="text" id="signer_1_id" placeholder="מספר ת.ז." />
                            </div>
                            <div class="form-group">
                                <label>אימייל *</label>
                                <input type="email" id="signer_1_email" placeholder="אימייל לחתימה" />
                            </div>
                        </div>
                    </div>
                    <div id="signer2Section" class="section-box hidden">
                        <h3>מורשה חתימה שני *</h3>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>שם מלא *</label>
                                <input type="text" id="signer_2_name" placeholder="שם מורשה חתימה" />
                            </div>
                            <div class="form-group">
                                <label>תעודת זהות *</label>
                                <input type="text" id="signer_2_id" placeholder="מספר ת.ז." />
                            </div>
                            <div class="form-group">
                                <label>אימייל *</label>
                                <input type="email" id="signer_2_email" placeholder="אימייל לחתימה" />
                            </div>
                        </div>
                    </div>

                    <!-- אישור מורשי חתימה - העלאת קובץ -->
                    <div class="form-group" style="margin-top: 1.25rem;">
                        <label style="color: #dc2626; font-weight: 600;">אישור מורשי חתימה *</label>
                        <p style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">נא לצרף אישור מורשי חתימה באימות עו"ד / רו"ח</p>
                        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('authFileInput').click()">
                            <input type="file" id="authFileInput" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp" onchange="handleFileSelect(event)" />
                            <svg class="file-upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            <div class="file-upload-text" id="fileUploadText">לחצו כאן להעלאת קובץ</div>
                            <div class="file-upload-hint" id="fileUploadHint">PDF או תמונה (עד 10MB)</div>
                        </div>
                    </div>

                    <!-- Honeypot -->
                    <div style="position:absolute;left:-9999px;" aria-hidden="true">
                        <label>Website</label>
                        <input type="text" id="honeypot" tabindex="-1" autocomplete="off" />
                    </div>
                </div>

                <div id="errorBox" class="error-box hidden">
                    <span id="errorText"></span>
                </div>

                <!-- Fix 3: Arrow directions corrected for RTL -->
                <div class="btn-row">
                    <button class="btn btn-outline" id="prevBtn" onclick="prevStep()" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                        הקודם
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                        הבא
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <button class="btn btn-success hidden" id="submitBtn" onclick="submitForm()">
                        ✓ שלח טופס
                    </button>
                </div>

            </div>
        </div>

        <p class="footer">© 2026 פנסיון מלא - כל הזכויות שמורות</p>
    </div>
</div>

<script>
const WEBHOOK_URL = 'https://pension-flow-79c43c9f.base44.app/api/apps/684b22e06236d9fe79c43c9f/functions/onboardingWebhook';
const UPLOAD_URL = 'https://pension-flow-79c43c9f.base44.app/api/apps/684b22e06236d9fe79c43c9f/functions/onboardingFileUpload';

let currentStep = 1;
let authorizationFileUrl = '';
const stepTitles = ['פרטי החברה', 'אנשי קשר', 'פרטי תשלום', 'מורשי חתימה'];

function val(id) { return document.getElementById(id)?.value?.trim() || ''; }

function isValidEmail(e) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function isValidBusinessId(id) { return /^\\d{9}$/.test(id); }
function isValidPhone(p) { return /^0\\d{9}$/.test(p.replace(/[-\\s]/g, '')); }
function isValidIsraeliId(id) {
    if (!id || !/^\\d{5,9}$/.test(id)) return false;
    const p = id.padStart(9, '0');
    let s = 0;
    for (let i = 0; i < 9; i++) { let d = parseInt(p[i]) * ((i % 2) + 1); if (d > 9) d -= 9; s += d; }
    return s % 10 === 0;
}

function toggleMasavFields() {
    document.getElementById('masavFields').classList.toggle('hidden', val('has_masav_code') !== 'yes');
}

function toggleSigner2() {
    document.getElementById('signer2Section').classList.toggle('hidden', val('signature_structure') !== 'two_signers');
}

function showError(msg) {
    document.getElementById('errorText').textContent = msg;
    document.getElementById('errorBox').classList.remove('hidden');
}
function hideError() { document.getElementById('errorBox').classList.add('hidden'); }

// File upload handling
async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('ניתן להעלות רק קבצי PDF או תמונה (JPG, PNG)');
        event.target.value = '';
        return;
    }
    if (file.size > 10 * 1024 * 1024) {
        alert('גודל הקובץ חייב להיות עד 10MB');
        event.target.value = '';
        return;
    }

    const area = document.getElementById('fileUploadArea');
    const textEl = document.getElementById('fileUploadText');
    const hintEl = document.getElementById('fileUploadHint');
    
    textEl.textContent = 'מעלה קובץ...';
    hintEl.textContent = '';

    try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(UPLOAD_URL, {
            method: 'POST',
            body: formData
        });
        const result = await res.json();
        
        if (result.file_url) {
            authorizationFileUrl = result.file_url;
            area.classList.add('uploaded');
            area.onclick = null;
            textEl.innerHTML = '✓ הקובץ הועלה בהצלחה';
            textEl.style.color = '#16a34a';
            textEl.style.fontWeight = '600';
            hintEl.textContent = file.name;
            hintEl.insertAdjacentHTML('afterend', '<button class="file-replace-btn" onclick="resetFileUpload(event)">החלף קובץ</button>');
        } else {
            throw new Error(result.error || 'שגיאה בהעלאה');
        }
    } catch (err) {
        console.error('Upload error:', err);
        textEl.textContent = 'לחצו כאן להעלאת קובץ';
        hintEl.textContent = 'PDF או תמונה (עד 10MB)';
        alert('שגיאה בהעלאת הקובץ. אנא נסו שוב.');
    }
}

function resetFileUpload(e) {
    if (e) { e.stopPropagation(); e.preventDefault(); }
    authorizationFileUrl = '';
    const area = document.getElementById('fileUploadArea');
    const textEl = document.getElementById('fileUploadText');
    const hintEl = document.getElementById('fileUploadHint');
    area.classList.remove('uploaded');
    area.onclick = function() { document.getElementById('authFileInput').click(); };
    textEl.textContent = 'לחצו כאן להעלאת קובץ';
    textEl.style.color = '';
    textEl.style.fontWeight = '';
    hintEl.textContent = 'PDF או תמונה (עד 10MB)';
    document.getElementById('authFileInput').value = '';
    const btn = area.querySelector('.file-replace-btn');
    if (btn) btn.remove();
}

function validateCurrentStep() {
    hideError();
    switch (currentStep) {
        case 1:
            if (!val('company_name') || !val('business_id') || !val('address') || !val('phone') || !val('deductions_file_number')) {
                showError('יש למלא את כל שדות החובה בעמוד זה'); return false;
            }
            if (!isValidBusinessId(val('business_id'))) { showError('מספר ח.פ. לא תקין - נדרשים 9 ספרות'); return false; }
            if (!isValidPhone(val('phone'))) { showError('מספר טלפון לא תקין - נדרשות 10 ספרות המתחילות ב-0'); return false; }
            if (!val('has_masav_code')) { showError('יש לבחור האם קיים קוד מוסד במס"ב'); return false; }
            if (val('has_masav_code') === 'yes' && (!val('institution_code') || !val('institution_name'))) {
                showError('יש למלא את שדות קוד מוסד ושם מוסד במס"ב'); return false;
            }
            return true;
        case 2:
            if (!val('main_contact_name') || !val('main_contact_phone') || !val('main_contact_email') || !val('invoice_email')) {
                showError('יש למלא את כל שדות החובה של איש קשר ראשי ואימייל לחשבוניות'); return false;
            }
            if (!isValidPhone(val('main_contact_phone'))) { showError('טלפון איש קשר ראשי לא תקין'); return false; }
            if (!isValidEmail(val('main_contact_email'))) { showError('אימייל איש קשר ראשי לא תקין'); return false; }
            if (!val('payroll_contact_name') || !val('payroll_contact_email')) {
                showError('יש למלא שם ואימייל של איש קשר שכר (הנה"ח)'); return false;
            }
            if (!isValidEmail(val('payroll_contact_email'))) { showError('אימייל איש קשר שכר לא תקין'); return false; }
            if (val('payroll_contact_phone') && !isValidPhone(val('payroll_contact_phone'))) { showError('טלפון איש קשר שכר לא תקין'); return false; }
            if (!isValidEmail(val('invoice_email'))) { showError('אימייל לחשבוניות לא תקין'); return false; }
            return true;
        case 3:
            if (!val('payment_method_to_funds')) { showError('יש לבחור אופן תשלום לקופות'); return false; }
            if (!val('bank_name') || !val('bank_branch_number') || !val('bank_account_number')) {
                showError('יש למלא את כל פרטי חשבון הבנק'); return false;
            }
            if (!val('payment_choice')) { showError('יש לבחור אופן תשלום לפנסיון מלא'); return false; }
            return true;
        case 4:
            if (!val('signature_structure')) { showError('יש לבחור מבנה חתימה'); return false; }
            if (!val('signer_1_name') || !val('signer_1_id') || !val('signer_1_email')) {
                showError('יש למלא את כל פרטי מורשה חתימה ראשון'); return false;
            }
            if (!isValidIsraeliId(val('signer_1_id'))) { showError('מספר ת.ז. של מורשה חתימה ראשון לא תקין'); return false; }
            if (!isValidEmail(val('signer_1_email'))) { showError('אימייל של מורשה חתימה ראשון לא תקין'); return false; }
            if (val('signature_structure') === 'two_signers') {
                if (!val('signer_2_name') || !val('signer_2_id') || !val('signer_2_email')) {
                    showError('יש למלא את כל פרטי מורשה חתימה שני'); return false;
                }
                if (!isValidIsraeliId(val('signer_2_id'))) { showError('מספר ת.ז. של מורשה חתימה שני לא תקין'); return false; }
                if (!isValidEmail(val('signer_2_email'))) { showError('אימייל של מורשה חתימה שני לא תקין'); return false; }
            }
            if (!authorizationFileUrl) { showError('יש לצרף אישור מורשי חתימה באימות עו"ד / רו"ח'); return false; }
            return true;
    }
    return true;
}

function updateUI() {
    for (let i = 1; i <= 4; i++) {
        document.getElementById('step' + i).classList.toggle('hidden', i !== currentStep);
        document.getElementById('stepCircle' + i).classList.toggle('active', i <= currentStep);
        document.getElementById('stepLabel' + i).classList.toggle('active', i <= currentStep);
    }
    document.getElementById('stepTitle').textContent = stepTitles[currentStep - 1];
    document.getElementById('stepDesc').textContent = 'שלב ' + currentStep + ' מתוך 4';
    document.getElementById('prevBtn').disabled = currentStep === 1;
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 4);
    document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 4);
    hideError();
}

function nextStep() {
    if (validateCurrentStep() && currentStep < 4) { currentStep++; updateUI(); }
}
function prevStep() {
    if (currentStep > 1) { currentStep--; updateUI(); }
}

async function submitForm() {
    if (val('honeypot')) {
        document.getElementById('mainForm').classList.add('hidden');
        document.getElementById('successScreen').classList.remove('hidden');
        return;
    }

    if (!validateCurrentStep()) return;

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> שולח...';

    const data = {
        company_name: val('company_name'),
        business_id: val('business_id'),
        address: val('address'),
        phone: val('phone'),
        deductions_file_number: val('deductions_file_number'),
        has_masav_code: val('has_masav_code'),
        institution_code: val('institution_code'),
        institution_name: val('institution_name'),
        payment_method_to_funds: val('payment_method_to_funds'),
        bank_name: val('bank_name'),
        bank_branch_number: val('bank_branch_number'),
        bank_account_number: val('bank_account_number'),
        salary_start_month: val('salary_start_month'),
        main_contact_name: val('main_contact_name'),
        main_contact_role: val('main_contact_role'),
        main_contact_phone: val('main_contact_phone'),
        main_contact_email: val('main_contact_email'),
        payroll_contact_name: val('payroll_contact_name'),
        payroll_contact_email: val('payroll_contact_email'),
        payroll_contact_phone: val('payroll_contact_phone'),
        invoice_email: val('invoice_email'),
        signature_structure: val('signature_structure'),
        signer_1_name: val('signer_1_name'),
        signer_1_id: val('signer_1_id'),
        signer_1_email: val('signer_1_email'),
        signer_2_name: val('signer_2_name'),
        signer_2_id: val('signer_2_id'),
        signer_2_email: val('signer_2_email'),
        payment_choice: val('payment_choice'),
        authorization_file_url: authorizationFileUrl,
    };

    try {
        const res = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            document.getElementById('mainForm').classList.add('hidden');
            document.getElementById('successScreen').classList.remove('hidden');
        } else {
            showError(result.error || 'שגיאה בשליחת הטופס');
            btn.disabled = false;
            btn.innerHTML = '✓ שלח טופס';
        }
    } catch (err) {
        showError('שגיאה בשליחת הטופס. אנא נסו שוב.');
        btn.disabled = false;
        btn.innerHTML = '✓ שלח טופס';
    }
}
</script>

</body>
</html>
`;

export default function ExternalFormHTML() {
  return null; // This is just a container for the HTML code
}
