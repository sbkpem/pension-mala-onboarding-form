<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—×ª×™××” ×¢×œ ××¡××›×™× - ×¤× ×¡×™×•×Ÿ ××œ×</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #eff6ff, #e0e7ff); min-height: 100vh; direction: rtl; }
        .container { max-width: 900px; margin: 0 auto; padding: 1rem; }

        /* Status screens */
        .status-screen { text-align: center; padding: 3rem 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 500px; margin: 4rem auto; }
        .status-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; }
        .status-icon.loading { background: #dbeafe; }
        .status-icon.error { background: #fecaca; }
        .status-icon.success { background: #dcfce7; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(37,99,235,0.2); border-radius: 50%; border-top-color: #2563eb; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Cards */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); overflow: hidden; margin-bottom: 1rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .card-header.blue { background: linear-gradient(to left, #eff6ff, #dbeafe); }
        .card-header.green { background: linear-gradient(to left, #f0fdf4, #dcfce7); }
        .card-body { padding: 1.5rem; }

        /* Document viewer */
        .doc-item { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.75rem; overflow: hidden; }
        .doc-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; cursor: pointer; background: #fafafa; }
        .doc-header:hover { background: #f3f4f6; }
        .doc-content { max-height: 400px; overflow-y: auto; padding: 1.5rem; border-top: 1px solid #e5e7eb; direction: rtl; line-height: 1.8; background: #ffffff; }
        .doc-content h1, .doc-content h2, .doc-content h3 { color: #1e3a5f; font-weight: 700; }
        .doc-content h1 { font-size: 1.5rem; text-align: center; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5em; }
        .doc-content h2 { font-size: 1.2rem; background: linear-gradient(to left, #e0e7ff, #f8fafc); padding: 0.5em 1em; border-radius: 4px; border-right: 4px solid #3b82f6; }
        .doc-content .ql-align-center { text-align: center; }
        .doc-content .ql-align-right { text-align: right; }
        .doc-content .ql-align-left { text-align: left; }
        .doc-content .ql-align-justify { text-align: justify; }
        .doc-footer { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-top: 1px solid #e5e7eb; background: #f9fafb; }

        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-orange { background: #ffedd5; color: #9a3412; }
        .badge-blue { background: #dbeafe; color: #1e40af; }

        /* Signature area */
        .sig-canvas-wrap { border: 2px dashed #d1d5db; border-radius: 8px; background: white; padding: 0.5rem; margin-bottom: 1rem; }
        .sig-canvas-wrap canvas { width: 100%; cursor: crosshair; touch-action: none; display: block; }
        .sig-preview { border: 2px solid #86efac; border-radius: 8px; background: #f0fdf4; padding: 1rem; text-align: center; margin-bottom: 1rem; }
        .sig-preview img { max-height: 80px; }

        /* Stamp area */
        .stamp-options { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .stamp-btn { flex: 1; padding: 0.625rem; border-radius: 8px; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 0.875rem; text-align: center; transition: all 0.2s; }
        .stamp-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .stamp-btn:hover:not(.active) { background: #f9fafb; }
        .stamp-info { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }

        .btn { padding: 0.625rem 1.5rem; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover:not(:disabled) { background: #15803d; }
        .btn-outline { background: white; color: #374151; border: 1px solid #d1d5db; }
        .btn-outline:hover:not(:disabled) { background: #f9fafb; }
        .btn-block { width: 100%; justify-content: center; }
        .btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }

        .hidden { display: none !important; }
        .warning-box { background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 0.75rem 1rem; color: #9a3412; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }

        .file-upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload-area:hover { border-color: #2563eb; background: #eff6ff; }
        .file-upload-area input[type="file"] { display: none; }

        .check-row { display: flex; align-items: center; gap: 0.5rem; }
        .check-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: #2563eb; }
    </style>
</head>
<body>

<div class="container">
    <!-- Loading -->
    <div id="loadingScreen" class="status-screen">
        <div class="status-icon loading"><div class="spinner"></div></div>
        <h2 style="font-size:1.25rem;color:#111827;margin-bottom:0.5rem;">×˜×•×¢×Ÿ ××¡××›×™×...</h2>
        <p style="color:#6b7280;">×× × ×”××ª×Ÿ ×‘×–××Ÿ ×©×× ×—× ×• ××›×™× ×™× ××ª ×”××¡××›×™× ×©×œ×š</p>
    </div>

    <!-- Error -->
    <div id="errorScreen" class="status-screen hidden">
        <div class="status-icon error">
            <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="#dc2626" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
        </div>
        <h2 style="font-size:1.25rem;color:#111827;margin-bottom:0.5rem;">×©×’×™××”</h2>
        <p id="errorMessage" style="color:#6b7280;margin-bottom:0.5rem;"></p>
        <p style="font-size:0.8rem;color:#9ca3af;">×× × × ×¡×” ×©×•×‘ ××• ×¤× ×” ×œ×ª××™×›×”</p>
    </div>

    <!-- Success -->
    <div id="successScreen" class="status-screen hidden">
        <div class="status-icon success">
            <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="#16a34a" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <h2 id="successTitle" style="font-size:1.25rem;color:#111827;margin-bottom:0.5rem;">×”××¡××›×™× × ×—×ª××• ×‘×”×¦×œ×—×”!</h2>
        <p id="successMessage" style="color:#6b7280;margin-bottom:1rem;"></p>
        <div style="background:#eff6ff;padding:0.75rem;border-radius:8px;">
            <p style="font-size:0.875rem;color:#1e40af;font-weight:500;">ğŸ’¡ ×”××¡××›×™× ×”×—×ª×•××™× ×™×™×©×œ×—×• ×œ××™××™×™×œ ×©×œ×š</p>
        </div>
        <p style="font-size:0.75rem;color:#9ca3af;margin-top:1rem;">× ×™×ª×Ÿ ×œ×¡×’×•×¨ ×—×œ×•×Ÿ ×–×” ×‘×‘×˜×—×”</p>
    </div>

    <!-- Review Step -->
    <div id="reviewStep" class="hidden">
        <div class="card">
            <div class="card-header blue">
                <h2 style="color:#1e3a8a;font-size:1.1rem;margin:0;">ğŸ“„ ××¡××›×™× ×œ×—×ª×™××” - <span id="companyName"></span></h2>
            </div>
            <div class="card-body" style="padding:1rem 1.5rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <p id="signerLabel" style="color:#374151;font-size:0.875rem;font-weight:500;"></p>
                        <p style="color:#6b7280;font-size:0.8rem;">×™×© ×œ×¢×™×™×Ÿ ×‘×›×œ ×”××¡××›×™× ×•×œ×¡××Ÿ ×©×§×¨××ª ××•×ª× ×œ×¤× ×™ ×”×—×ª×™××”</p>
                    </div>
                    <span id="viewedCount" class="badge badge-blue">0 / 0 ××¡××›×™× × ×¦×¤×•</span>
                </div>
            </div>
        </div>

        <div id="documentsList"></div>

        <div class="card">
            <div class="card-body" style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;">
                <p id="continueMessage" style="color:#6b7280;font-size:0.875rem;"></p>
                <button class="btn btn-green" id="continueToSignBtn" disabled onclick="goToSignStep()">×”××©×š ×œ×—×ª×™××” âœï¸</button>
            </div>
        </div>
    </div>

    <!-- Sign Step -->
    <div id="signStep" class="hidden">
        <div class="card">
            <div class="card-header green">
                <h2 style="color:#166534;font-size:1.1rem;margin:0;">âœï¸ ×—×ª×™××” ×¢×œ <span id="docCountLabel"></span> ××¡××›×™×</h2>
            </div>
            <div class="card-body">
                <p id="signInstructions" style="color:#6b7280;font-size:0.875rem;"></p>
            </div>
        </div>

        <!-- Signature -->
        <div class="card">
            <div class="card-header"><h3 style="font-size:1rem;margin:0;">×—×ª×™××”</h3></div>
            <div class="card-body">
                <div id="signatureInput">
                    <div class="sig-canvas-wrap">
                        <canvas id="sigCanvas" width="500" height="150"></canvas>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-outline" onclick="clearCanvas()">ğŸ”„ × ×§×”</button>
                        <button class="btn btn-primary" onclick="saveSignature()" style="flex:1;">âœ“ ×©××•×¨ ×—×ª×™××”</button>
                    </div>
                </div>
                <div id="signatureSaved" class="hidden">
                    <div class="sig-preview">
                        <p style="font-size:0.8rem;color:#166534;margin-bottom:0.5rem;">×”×—×ª×™××” × ×©××¨×”:</p>
                        <img id="savedSignatureImg" alt="×—×ª×™××”" />
                    </div>
                    <button class="btn btn-outline btn-block" onclick="resetSignature()">ğŸ”„ ×—×ª×•× ××—×“×©</button>
                </div>
            </div>
        </div>

        <!-- Stamp (signer 1 only) -->
        <div id="stampSection" class="card hidden">
            <div class="card-header"><h3 style="font-size:1rem;margin:0;">×—×•×ª××ª ×—×‘×¨×”</h3></div>
            <div class="card-body">
                <div id="stampInput">
                    <div class="stamp-options">
                        <div class="stamp-btn active" id="virtualStampBtn" onclick="setStampMode('virtual')">ğŸ¢ ×—×•×ª××ª ×•×™×¨×˜×•××œ×™×ª</div>
                        <div class="stamp-btn" id="uploadStampBtn" onclick="setStampMode('upload')">ğŸ“¤ ×”×¢×œ××ª ×—×•×ª××ª</div>
                    </div>
                    <div id="virtualStampSection">
                        <div class="stamp-info">
                            <p style="font-size:0.8rem;color:#1e40af;margin-bottom:0.5rem;font-weight:500;">×—×•×ª××ª ×•×™×¨×˜×•××œ×™×ª ×ª×›×œ×•×œ:</p>
                            <ul style="font-size:0.8rem;color:#1e40af;padding-right:1.25rem;">
                                <li id="stampCompanyName"></li>
                                <li id="stampBusinessId"></li>
                                <li id="stampAddress"></li>
                            </ul>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="generateVirtualStamp()">ğŸ¢ ×¦×•×¨ ×—×•×ª××ª ×•×™×¨×˜×•××œ×™×ª</button>
                    </div>
                    <div id="uploadStampSection" class="hidden">
                        <p style="font-size:0.8rem;color:#6b7280;margin-bottom:0.75rem;">×”×¢×œ×” ×ª××•× ×ª ×—×•×ª××ª ××”××—×©×‘ (PNG, JPG)</p>
                        <input type="file" id="stampFileInput" accept="image/*" onchange="handleStampUpload(event)" style="display:none;" />
                        <button class="btn btn-outline btn-block" onclick="document.getElementById('stampFileInput').click()">ğŸ“¤ ×‘×—×¨ ×§×•×‘×¥ ×—×•×ª××ª</button>
                    </div>
                </div>
                <div id="stampSaved" class="hidden">
                    <div class="sig-preview">
                        <p style="font-size:0.8rem;color:#166534;margin-bottom:0.5rem;">×”×—×•×ª××ª × ×©××¨×”:</p>
                        <img id="savedStampImg" alt="×—×•×ª××ª" style="max-height:120px;" />
                    </div>
                    <button class="btn btn-outline btn-block" onclick="resetStamp()">ğŸ”„ ×‘×—×¨ ×—×•×ª××ª ××—×¨×ª</button>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="card">
            <div class="card-body">
                <div id="signatureWarning" class="warning-box">
                    âš ï¸ ×™×© ×œ×œ×—×•×¥ ×¢×œ "×©××•×¨ ×—×ª×™××”" ×œ×¤× ×™ ×”×©×œ×™×—×”
                </div>
                <div class="btn-row">
                    <button class="btn btn-outline" onclick="goToReviewStep()" style="flex:1;">×—×–×•×¨ ×œ×¦×¤×™×™×”</button>
                    <button class="btn btn-green" id="submitBtn" disabled onclick="submitSignatures()" style="flex:1;">âœ“ ×©×œ×— ××ª ×›×œ ×”×—×ª×™××•×ª</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = 'https://pension-flow-79c43c9f.base44.app/api/apps/684b22e06236d9fe79c43c9f/functions';
const GET_DOCS_URL = API_BASE + '/getSigningDocuments';
const SUBMIT_URL = API_BASE + '/submitSignatures';
const WATERMARK_URL = API_BASE + '/watermarkImage';

let state = {
    submissionId: null,
    token: null,
    signer: 'signer_1',
    signerIndex: 1,
    signerName: '',
    companyData: null,
    documents: [],
    viewedDocs: {},
    signatureData: null,
    stampData: null,
    stampMode: 'virtual'
};

// Parse URL params
const urlParams = new URLSearchParams(window.location.search);
state.submissionId = urlParams.get('submission_id');
state.token = urlParams.get('token');
state.signer = urlParams.get('signer') || 'signer_1';
state.signerIndex = state.signer === 'signer_2' ? 2 : 1;

if (!state.submissionId || !state.token) {
    showError('×§×™×©×•×¨ ×—×ª×™××” ×œ× ×ª×§×™×Ÿ - ×—×¡×¨×™× ×¤×¨××˜×¨×™×');
} else {
    loadDocuments();
}

async function loadDocuments() {
    try {
        const res = await fetch(GET_DOCS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                submission_id: state.submissionId,
                token: state.token,
                signer: state.signer
            })
        });
        const data = await res.json();
        
        if (!data.success) {
            showError(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¡××›×™×');
            return;
        }

        state.companyData = data.companyData;
        state.documents = data.documents;
        state.signerIndex = data.signerIndex;
        state.signerName = data.signerName || '';

        renderReviewStep();
        show('reviewStep');
        hide('loadingScreen');
    } catch (err) {
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¡××›×™×. ×× × × ×¡×” ×©×•×‘.');
    }
}

async function watermarkDocImages(containerEl, docName) {
    var imgs = containerEl.querySelectorAll('img');
    var urlsToWatermark = [];
    var urlImgElements = [];
    var dataUriImages = [];
    
    imgs.forEach(function(img) {
        var src = img.getAttribute('src') || '';
        // Skip logos
        if (src.indexOf('logo') !== -1) return;
        // Skip already watermarked SVGs
        if (src.startsWith('data:image/svg+xml')) return;
        // HTTP URLs - batch watermark on server
        if (src.startsWith('http')) {
            urlsToWatermark.push(src);
            urlImgElements.push(img);
        }
        // Data URI images (base64 png/jpeg) - send individually to server
        if (src.startsWith('data:image/png') || src.startsWith('data:image/jpeg') || src.startsWith('data:image/jpg')) {
            dataUriImages.push(img);
        }
    });
    
    // Batch watermark URL images on server
    if (urlsToWatermark.length > 0) {
        var results = await getServerWatermarkForUrls(urlsToWatermark, docName);
        urlImgElements.forEach(function(img) {
            var originalSrc = img.getAttribute('src');
            if (results[originalSrc]) {
                img.src = results[originalSrc];
            }
        });
    }
    
    // Watermark data URI images individually on server
    for (var i = 0; i < dataUriImages.length; i++) {
        var img = dataUriImages[i];
        var watermarked = await getServerWatermark(img.getAttribute('src'), 'pm_image', docName);
        if (watermarked) {
            img.src = watermarked;
        }
    }
}

function renderReviewStep() {
    document.getElementById('companyName').textContent = state.companyData.name;
    
    // Show greeting with signer name
    var signerTitle = state.signerIndex === 1 ? '××•×¨×©×” ×—×ª×™××” ×¨××©×•×Ÿ' : '××•×¨×©×” ×—×ª×™××” ×©× ×™';
    if (state.signerName) {
        document.getElementById('signerLabel').innerHTML = '×©×œ×•× ' + state.signerName + ', <span style="color:#6b7280;font-weight:400;">(' + signerTitle + ')</span>';
    } else {
        document.getElementById('signerLabel').textContent = signerTitle;
    }
    updateViewedCount();

    const list = document.getElementById('documentsList');
    list.innerHTML = '';
    state.documents.forEach(function(doc, i) {
        var item = document.createElement('div');
        item.className = 'doc-item';
        item.id = 'doc-' + doc.id;
        var docName = doc.template_name || ('××¡××š ' + (i+1));
        var docNum = (i+1) + ' ××ª×•×š ' + state.documents.length;
        var htmlContent = doc.html_content || '<p>×ª×•×›×Ÿ ×”××¡××š ××™× ×• ×–××™×Ÿ</p>';

        var headerDiv = document.createElement('div');
        headerDiv.className = 'doc-header';
        headerDiv.onclick = function() { toggleDoc(doc.id); };
        headerDiv.innerHTML = '<div style="display:flex;align-items:center;gap:0.5rem;"><span>ğŸ“„</span><div><strong>' + docName + '</strong><div style="font-size:0.75rem;color:#9ca3af;">××¡××š ' + docNum + '</div></div></div><span class="badge badge-orange" id="badge-' + doc.id + '">×˜×¨× × ×¦×¤×”</span>';

        var contentDiv = document.createElement('div');
        contentDiv.className = 'doc-content hidden';
        contentDiv.id = 'content-' + doc.id;
        contentDiv.innerHTML = htmlContent;

        // Watermark all images in document content (PM signatures/stamps)
        watermarkDocImages(contentDiv, docName);

        var footerDiv = document.createElement('div');
        footerDiv.className = 'doc-footer hidden';
        footerDiv.id = 'footer-' + doc.id;

        var checkRow = document.createElement('div');
        checkRow.className = 'check-row';
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = 'check-' + doc.id;
        cb.onchange = function() { markViewed(doc.id); };
        var lbl = document.createElement('label');
        lbl.htmlFor = 'check-' + doc.id;
        lbl.style.cssText = 'font-size:0.875rem;cursor:pointer;';
        lbl.textContent = '×§×¨××ª×™ ×•×”×‘× ×ª×™ ××ª ×ª×•×›×Ÿ ×”××¡××š';
        checkRow.appendChild(cb);
        checkRow.appendChild(lbl);

        var viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-primary';
        viewBtn.id = 'viewBtn-' + doc.id;
        viewBtn.onclick = function() { markViewed(doc.id); };
        viewBtn.textContent = 'ğŸ‘ï¸ ×¡××Ÿ ×›× ×¦×¤×”';

        footerDiv.appendChild(checkRow);
        footerDiv.appendChild(viewBtn);

        item.appendChild(headerDiv);
        item.appendChild(contentDiv);
        item.appendChild(footerDiv);
        list.appendChild(item);
    });

    // Auto-expand first
    if (state.documents.length > 0) {
        toggleDoc(state.documents[0].id);
    }
}

function toggleDoc(docId) {
    const content = document.getElementById('content-' + docId);
    const footer = document.getElementById('footer-' + docId);
    const isHidden = content.classList.contains('hidden');
    
    // Close all
    state.documents.forEach(d => {
        document.getElementById('content-' + d.id)?.classList.add('hidden');
        document.getElementById('footer-' + d.id)?.classList.add('hidden');
    });

    if (isHidden) {
        content.classList.remove('hidden');
        footer.classList.remove('hidden');
    }
}

function markViewed(docId) {
    state.viewedDocs[docId] = true;
    const badge = document.getElementById('badge-' + docId);
    badge.className = 'badge badge-green';
    badge.textContent = 'âœ“ × ×¦×¤×”';
    const check = document.getElementById('check-' + docId);
    if (check) check.checked = true;
    const viewBtn = document.getElementById('viewBtn-' + docId);
    if (viewBtn) viewBtn.classList.add('hidden');
    updateViewedCount();
}

function updateViewedCount() {
    const viewed = Object.keys(state.viewedDocs).length;
    const total = state.documents.length;
    document.getElementById('viewedCount').textContent = viewed + ' / ' + total + ' ××¡××›×™× × ×¦×¤×•';
    
    const allViewed = viewed >= total && total > 0;
    document.getElementById('continueToSignBtn').disabled = !allViewed;
    document.getElementById('continueMessage').textContent = allViewed 
        ? '×›×œ ×”××¡××›×™× × ×¦×¤×•. × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×—×ª×™××”.' 
        : '×™×© ×œ×¦×¤×•×ª ×‘×›×œ ×”××¡××›×™× ×œ×¤× ×™ ×”××©×š ×œ×—×ª×™××”';
}

function goToSignStep() {
    hide('reviewStep');
    show('signStep');
    
    document.getElementById('docCountLabel').textContent = state.documents.length;
    
    if (state.signerIndex === 1) {
        document.getElementById('signInstructions').textContent = '×™×© ×œ×”×•×¡×™×£ ×—×ª×™××” ×•×—×•×ª××ª. ×”×—×ª×™××” ×•×”×—×•×ª××ª ×™×•×—×œ×• ×¢×œ ×›×œ ×”××¡××›×™×.';
        show('stampSection');
        document.getElementById('stampCompanyName').textContent = 'â€¢ ×©× ×”×—×‘×¨×”: ' + state.companyData.name;
        document.getElementById('stampBusinessId').textContent = 'â€¢ ×—.×¤.: ' + state.companyData.businessId;
        document.getElementById('stampAddress').textContent = 'â€¢ ×›×ª×•×‘×ª: ' + state.companyData.address;
    } else {
        document.getElementById('signInstructions').textContent = '×™×© ×œ×”×•×¡×™×£ ×—×ª×™××” ×‘×œ×‘×“. ×”×—×•×ª××ª ×›×‘×¨ × ×•×¡×¤×” ×¢×œ ×™×“×™ ××•×¨×©×” ×”×—×ª×™××” ×”×¨××©×•×Ÿ.';
    }

    initCanvas();
    updateSubmitBtn();
}

function goToReviewStep() {
    hide('signStep');
    show('reviewStep');
}

// Canvas
let isDrawing = false;
function initCanvas() {
    const canvas = document.getElementById('sigCanvas');
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', doDraw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseleave', stopDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', doDraw, { passive: false });
    canvas.addEventListener('touchend', stopDraw);
}

function getPos(e) {
    const canvas = document.getElementById('sigCanvas');
    const rect = canvas.getBoundingClientRect();
    const sx = canvas.width / rect.width;
    const sy = canvas.height / rect.height;
    const cx = e.clientX || e.touches?.[0]?.clientX || 0;
    const cy = e.clientY || e.touches?.[0]?.clientY || 0;
    return { x: (cx - rect.left) * sx, y: (cy - rect.top) * sy };
}

function startDraw(e) {
    e.preventDefault();
    isDrawing = true;
    const ctx = document.getElementById('sigCanvas').getContext('2d');
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
}

function doDraw(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const ctx = document.getElementById('sigCanvas').getContext('2d');
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();
}

function stopDraw() { isDrawing = false; }

function clearCanvas() {
    const canvas = document.getElementById('sigCanvas');
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}

async function getServerWatermark(imageData, imageType, docName) {
    try {
        var res = await fetch(WATERMARK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image_data: imageData,
                image_type: imageType,
                submission_id: state.submissionId,
                token: state.token,
                company_name: state.companyData ? state.companyData.name : '',
                signer_name: state.signerName || '',
                document_name: docName || ''
            })
        });
        var data = await res.json();
        if (data.success && data.watermarked_image) {
            return data.watermarked_image;
        }
        return imageData;
    } catch (err) {
        console.log('Server watermark failed, using original:', err);
        return imageData;
    }
}

async function getServerWatermarkForUrls(imageUrls, docName) {
    try {
        var res = await fetch(WATERMARK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image_urls: imageUrls,
                submission_id: state.submissionId,
                token: state.token,
                company_name: state.companyData ? state.companyData.name : '',
                signer_name: state.signerName || '',
                document_name: docName || ''
            })
        });
        var data = await res.json();
        if (data.success && data.watermarked_images) {
            return data.watermarked_images;
        }
        return {};
    } catch (err) {
        console.log('Server watermark for URLs failed:', err);
        return {};
    }
}

async function saveSignature() {
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    const px = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    if (!px.some(p => p !== 0)) { alert('×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×”×©××™×¨×”'); return; }
    
    state.signatureData = canvas.toDataURL('image/png');
    // Send to server for watermarking, display watermarked preview
    var wmPreview = await getServerWatermark(state.signatureData, 'signature', '');
    document.getElementById('savedSignatureImg').src = wmPreview;
    hide('signatureInput');
    show('signatureSaved');
    hide('signatureWarning');
    updateSubmitBtn();
}

function resetSignature() {
    state.signatureData = null;
    clearCanvas();
    show('signatureInput');
    hide('signatureSaved');
    show('signatureWarning');
    updateSubmitBtn();
}

// Stamp
function setStampMode(mode) {
    state.stampMode = mode;
    document.getElementById('virtualStampBtn').className = 'stamp-btn' + (mode === 'virtual' ? ' active' : '');
    document.getElementById('uploadStampBtn').className = 'stamp-btn' + (mode === 'upload' ? ' active' : '');
    if (mode === 'virtual') { show('virtualStampSection'); hide('uploadStampSection'); }
    else { hide('virtualStampSection'); show('uploadStampSection'); }
}

async function generateVirtualStamp() {
    const cd = state.companyData;
    if (!cd) return;
    
    const size = 400;
    const canvas = document.createElement('canvas');
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, size, size);
    
    const cx = size/2, cy = size/2, R = 185;
    const color = '#0a1e5e';
    
    ctx.strokeStyle = color; ctx.lineWidth = 7;
    ctx.beginPath(); ctx.arc(cx, cy, R, 0, Math.PI*2); ctx.stroke();
    ctx.lineWidth = 2.5;
    ctx.beginPath(); ctx.arc(cx, cy, R-11, 0, Math.PI*2); ctx.stroke();
    
    // Company name arc
    const name = cd.name || '';
    ctx.save(); ctx.translate(cx, cy);
    ctx.fillStyle = color; ctx.font = 'bold 31px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    const arcSpan = Math.min(Math.PI*1.5, Math.max(Math.PI*0.9, name.length*0.13));
    const arcStart = -Math.PI/2 - arcSpan/2;
    const arcStep = name.length > 1 ? arcSpan/(name.length-1) : 0;
    const textR = R - 30;
    for (let i=0; i<name.length; i++) {
        const ci = name.length-1-i;
        const a = arcStart + arcStep*i;
        ctx.save();
        ctx.translate(Math.cos(a)*textR, Math.sin(a)*textR);
        ctx.rotate(a + Math.PI/2);
        ctx.fillText(name[ci], 0, 0);
        ctx.restore();
    }
    ctx.restore();
    
    // Inner circle
    ctx.strokeStyle = color; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(cx, cy, R-52, 0, Math.PI*2); ctx.stroke();
    
    // Lines
    ctx.strokeStyle = color; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(cx-65, cy-22); ctx.lineTo(cx+65, cy-22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx-65, cy+22); ctx.lineTo(cx+65, cy+22); ctx.stroke();
    
    // Business ID
    ctx.fillStyle = color; ctx.font = 'bold 26px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('×—.×¤. ' + (cd.businessId || ''), cx, cy);
    
    // Date
    ctx.font = 'bold 17px Arial';
    ctx.fillText(new Date().toLocaleDateString('he-IL'), cx, cy+40);
    
    // Address arc bottom
    const addr = (cd.address || '').substring(0, 25);
    if (addr) {
        ctx.save(); ctx.translate(cx, cy);
        ctx.fillStyle = color; ctx.font = 'bold 18px Arial';
        const aSpan = Math.min(Math.PI*1.1, Math.max(Math.PI*0.5, addr.length*0.07));
        const aStart = Math.PI/2 + aSpan/2;
        const aStep = addr.length > 1 ? aSpan/(addr.length-1) : 0;
        for (let i=0; i<addr.length; i++) {
            const ci = addr.length-1-i;
            const a = aStart - aStep*i;
            ctx.save();
            ctx.translate(Math.cos(a)*textR, Math.sin(a)*textR);
            ctx.rotate(a - Math.PI/2);
            ctx.fillText(addr[ci], 0, 0);
            ctx.restore();
        }
        ctx.restore();
    }
    
    state.stampData = canvas.toDataURL('image/png');
    var wmPreview = await getServerWatermark(state.stampData, 'stamp', '');
    document.getElementById('savedStampImg').src = wmPreview;
    hide('stampInput');
    show('stampSaved');
    updateSubmitBtn();
}

function handleStampUpload(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
        state.stampData = ev.target.result;
        var wmPreview = await getServerWatermark(state.stampData, 'stamp', '');
        document.getElementById('savedStampImg').src = wmPreview;
        hide('stampInput');
        show('stampSaved');
        updateSubmitBtn();
    };
    reader.readAsDataURL(file);
}

function resetStamp() {
    state.stampData = null;
    show('stampInput');
    hide('stampSaved');
    updateSubmitBtn();
}

function updateSubmitBtn() {
    const hasSig = !!state.signatureData;
    const hasStamp = state.signerIndex !== 1 || !!state.stampData;
    document.getElementById('submitBtn').disabled = !hasSig || !hasStamp;
}

async function submitSignatures() {
    if (!state.signatureData) { alert('×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×”×©×œ×™×—×”'); return; }
    if (state.signerIndex === 1 && !state.stampData) { alert('×™×© ×œ×”×•×¡×™×£ ×—×•×ª××ª'); return; }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;"></span> ×©×•×œ×—...';

    try {
        const res = await fetch(SUBMIT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                submission_id: state.submissionId,
                token: state.token,
                signer_id: state.signer,
                signer_index: state.signerIndex,
                signature_data: state.signatureData,
                stamp_data: state.signerIndex === 1 ? state.stampData : null,
                documents_html: null
            })
        });
        const data = await res.json();

        if (data.success || data.documents_updated) {
            hide('signStep');
            const isLast = state.signerIndex === 2 || state.documents.some(d => !d.requires_two_signers);
            document.getElementById('successTitle').textContent = isLast ? '×›×œ ×”××¡××›×™× × ×—×ª××• ×‘×”×¦×œ×—×”!' : '×—×ª×™××ª×š × ×©××¨×” ×‘×”×¦×œ×—×”!';
            document.getElementById('successMessage').textContent = isLast 
                ? '×ª×•×“×” ×œ×š ×¢×œ ×—×ª×™××ª ×”××¡××›×™×. ×¢×•×ª×§×™× ×©×œ ×”××¡××›×™× ×”×—×ª×•××™× × ×©×œ×—×• ×œ××™××™×™×œ ×©×œ×š.'
                : '×ª×•×“×” ×œ×š ×¢×œ ×—×ª×™××ª ×”××¡××›×™×. ×¢×•×ª×§×™× ×™×™×©×œ×—×• ×œ××—×¨ ×”×©×œ××ª ×›×œ ×”×—×ª×™××•×ª.';
            show('successScreen');
        } else {
            alert(data.error || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×—×ª×™××•×ª');
            btn.disabled = false;
            btn.innerHTML = 'âœ“ ×©×œ×— ××ª ×›×œ ×”×—×ª×™××•×ª';
        }
    } catch (err) {
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×—×ª×™××•×ª. ×× × × ×¡×” ×©×•×‘.');
        btn.disabled = false;
        btn.innerHTML = 'âœ“ ×©×œ×— ××ª ×›×œ ×”×—×ª×™××•×ª';
    }
}

function showError(msg) {
    hide('loadingScreen');
    document.getElementById('errorMessage').textContent = msg;
    show('errorScreen');
}

function show(id) { document.getElementById(id)?.classList.remove('hidden'); }
function hide(id) { document.getElementById(id)?.classList.add('hidden'); }
</script>
</body>
</html>
